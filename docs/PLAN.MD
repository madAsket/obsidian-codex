План разработки Codex Plugin (MVP)

Задачи (MVP)

- Подготовить структуру исходников (main.ts минимальный, модули для UI, services, storage, types).
- Реализовать sidebar view с React, каркас UI: header, status block, чат, input.
- Настроить стили в духе агента в Cursor / Codex в VS Studio (сайдбар с чатом).
- Добавить управление вводом: Enter = отправить, Shift+Enter = новая строка.
- Подключить Codex TypeScript SDK: инициализация при открытии sidebar, workingDirectory = vault root, skipGitRepoCheck = true.
- Обеспечить безопасный режим: read-only, approvals never, network off; если флаги недоступны — локальный запрет tools/web на запрос.
- Реализовать сбор контекста активной заметки (валидация .md/.markdown, 50k символов, ошибки).
- Формировать запрос: текст пользователя + метаданные (отн. путь, имя, длина) + тело заметки.
- Поддержать streaming и cancel: Stop останавливает запрос, в чате фиксируется “Cancelled”.
- Хранить историю и threadId в data.json, лимит 150 сообщений, восстановление при перезапуске.
- Создавать AGENTS.md при установке плагина, не перезаписывать, если уже существует.
- Обработать ошибки и статусы (Needs login, Codex unavailable, Unexpected error).
- Команда Command Palette: только Toggle sidebar.

План по итерациям

Итерация 0 — каркас и подготовка
- Разнести код по модулям (ui, services, storage, types).
- Задать типы данных (Message, ChatState) и константы (разрешенные расширения).
- Подготовить систему хранения data.json.

Итерация 1 — UI и UX
- Реализовать sidebar view, рендер React-компонентов.
- Сверстать блоки header/status/чат/input.
- Добавить базовую стилизацию и состояния (empty, busy).

Итерация 2 — Codex интеграция
- Реализовать CodexService и инициализацию на открытие sidebar.
- Добавить системные инструкции и локальные запреты tools/web.
- Сформировать запрос и обработать ответ (включая streaming).

Итерация 3 — Контекст заметки
- Получение активной заметки и чтение содержимого.
- Валидация расширения, лимит 50k символов, подготовка метаданных.
- Ошибки: отсутствует заметка, неверный формат, ошибка чтения.

Итерация 4 — История и восстановление
- Сохранение/восстановление чата и threadId.
- Лимит 150 сообщений и очистка старых.
- Отображение истории при старте.

Итерация 5 — Полировка и критерии приемки
- Статусы (Needs login/Ready/Error/Busy) и тексты подсказок.
- Stop/Cancelled в UI.
- Проверка acceptance criteria и ручное тестирование.
