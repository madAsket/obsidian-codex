Техническое задание: Obsidian “Codex Plugin (MVP)

0) Цель

Сделать community-плагин для Obsidian, который добавляет сайдбар-панель с чат-интерфейсом на React, интегрированный с Codex через Codex TypeScript SDK. В MVP плагин умеет отвечать на вопросы пользователя, используя контекст активной заметки.

1) Платформы и окружение
	•	Поддержка: macOS + Linux (desktop).
	•	ID плагина: obsidian-codex (должен совпадать с именем папки).
	•	Codex CLI должен быть установлен в системе пользователем (плагин не устанавливает и не бандлит Codex).
	•	Авторизация Codex выполняется пользователем в терминале (плагин лишь проверяет статус).
	•	Vault пользователя синхронизируется (iCloud/Dropbox/Git и т.п.) ⇒ поэтому запрещено хранить секреты/авторизацию/персональные конфиги внутри vault.

2) Стек и стартовый шаблон
	•	Основа проекта: obsidian-codex.
	•	UI: React внутри плагина (использовать подход из “Use React in your plugin”) https://docs.obsidian.md/Plugins/Getting+started/Use+React+in+your+plugin .
	•	Интеграция с Codex https://github.com/openai/codex/tree/main и Codex TypeScript SDK - https://github.com/openai/codex/blob/main/sdk/typescript/README.md .

3) Основная функциональность MVP

3.1 Sidebar UI

Плагин добавляет отдельную view/pane в правый сайдбар:
	•	Стилизация: в стиле агента в Cursor / Codex в VS Studio (сайдбар с чатом, см. скриншот).
	1.	Header
        •	Название: “Codex”
        •	Индикатор статуса: Ready / Needs login / Error / Busy

	2.	Status block
        •	Codex installed: Yes/No (эвристика: попытка инициализации SDK)
        •	Auth: Logged in / Not logged in (по факту запроса: успех или ошибка авторизации)
        •	Vault: текущий vault name
        •	Safety: Read-only (MVP)
        •	Note limit: 50,000 chars

	3.	Chat transcript

        •	Сообщения User / Codex
        •	Показ процесса ответа (streaming либо “Thinking…”)
        •	Кнопка Stop (отмена текущего запроса)

	4.	Chat input

        •	Textarea
        •	Send button
        •	Enter = отправить, Shift+Enter = новая строка

3.2 Контекст: активная заметка

При каждом запросе:
	•	Берётся active note в Obsidian.
	•	Читается её содержимое из vault.
	•	Если нет активной заметки — выводится ошибка “Open a note first”.
	•	Если заметка не markdown (.md/.markdown) — ошибка “Only markdown notes supported” (список расширений — константа, позже перенесём в settings).
	•	Если длина контента > 50,000 символов — обрезаем до первых 50,000 (считаем по символам)

3.3 Ответ Codex
	•	Плагин отправляет запрос в Codex, включая:
	•	текст пользователя,
	•	метаданные заметки (путь относительный к vault, имя файла, длина),
	•	тело заметки (markdown).
	•	Ответ возвращается в чат.

3.4 История чата и thread
	•	На каждый vault — один чат (пока).
	•	История и threadId сохраняются в .obsidian/plugins/<plugin-id>/data.json.
	•	При перезапуске Obsidian:
	•	чат восстанавливается (минимум: отображение сохранённых сообщений),
	•	threadId сохраняется для будущего resume (даже если в MVP не делаем “продолжить” явно).

4) Codex интеграция (через TS SDK)

4.1 Инициализация
	•	На открытие sidebar создаётся CodexService.
	•	workingDirectory для Codex устанавливается в корень текущего vault.
	•	Включить skipGitRepoCheck = true, так как vault может не быть git-репозиторием.
	•	Ошибки инициализации отображаются в status block.

4.2 Безопасные режимы (обязательное требование)

Так как vault синкается, а MVP не должен ничего менять:
	•	Плагин не изменяет и не требует глобальный ~/.codex/config.toml.
	•	Плагин не создаёт .codex/ в vault и не использует CODEX_HOME=<vault>/.codex.
	•	Все ограничения задаются на уровне запуска/инициализации Codex (параметры или эквивалент в SDK):
	•	sandbox: read-only
	•	approvals: never (никаких интерактивных подтверждений в MVP)
	•	network: выключено (если есть настройка/флаг; если нет — запрет tools/web локально на уровне запроса)
	•	запрет на любые изменения файлов/создание файлов в MVP

Если SDK не даёт прямых параметров sandbox/approval — допустимо:
	•	прокидывать соответствующие параметры CLI через SDK-конфигурацию (если поддерживается)
	•	иначе достаточно локального запрета tools/web для конкретного запроса (без изменения глобальной конфигурации Codex)

4.3 Thread management
	•	При первом запросе создаётся новый thread.
	•	threadId сохраняется.
	•	В будущем должен быть возможен resume по threadId.

4.4 Streaming и cancel
	•	Желательно использовать streaming (если SDK поддерживает).
	•	Cancel:
	•	кнопка Stop должна прекращать текущий run/stream,
	•	в чате фиксируется событие “Cancelled”.

5) AGENTS.md (правила для vault)

5.1 Создание
	•	При установке плагина (onload) в vault:
	•	если в корне vault отсутствует AGENTS.md, плагин автоматически создаёт его.
	•	если AGENTS.md уже есть — плагин его не изменяет.

5.2 Содержание (требования, без секретов)

AGENTS.md должен быть коротким и содержать на английском инструкции:
	•	что это Obsidian vault и заметки — Markdown,
	•	что режим read-only: нельзя изменять файлы, нельзя создавать файлы, нельзя выполнять команды, нельзя использовать интернет,
	•	при запросах про заметки: отвечать на основе текста заметки, не выдумывать факты.

6) System prompt (MVP)

Так как формат ответа “свободный текст”, системные правила минимальны:
	•	“Отвечай на языке пользователя”
	•	“Основывайся только на тексте заметки”
	•	“Кратко и по делу”

Системные инструкции должны не конфликтовать с AGENTS.md, но и дублирование допустимо.

7) Хранение данных (data.json)

7.1 Структура данных (минимум)
	•	vaultName: string
	•	chat: { threadId: string|null, messages: Message[], updatedAt: number }
	•	Message: { id, role: "user"|"assistant"|"system", text, ts, meta? }
	•	meta для assistant может содержать noteName, notePath, chars length.

7.2 Ограничение размера

Чтобы data.json не рос бесконечно:
	•	хранить максимум 150 последних сообщений.

8) Ошибки и edge cases

Обработать и отобразить в UI:
	•	Ошибка чтения файла → показать текст ошибки
	•	Нет авторизации → статус “Needs login” + инструкция “Run codex login in terminal”
	•	Codex не установлен / SDK не может запуститься → “Codex unavailable”
	•	Cancel → “Cancelled”
	•	Любая неожиданная ошибка → “Unexpected error”, лог в console

9) Команды (Command Palette)
	•	Codex: Toggle sidebar

10) Нефункциональные требования
	•	Не хранить секреты/ключи/авторизацию в vault.
	•	Не менять глобальные настройки Codex пользователя.
	•	Минимизировать риск prompt-injection:
        •	в MVP нет tools, нет выполнения команд, нет записи в файлы.
        •	Логи: только технические, без печати полного содержимого заметок в console (чтобы не утекало через логи).

11) План расширения (не в MVP, но заложить архитектуру)

Чтобы позже добавить “правит и создаёт заметки”:
	•	Поддержать режим “Propose changes”:
	•	Codex возвращает structured output (patch/edit ops),
	•	UI показывает preview,
	•	пользователь подтверждает Apply.
	•	Переход на write-режим должен быть отдельным переключателем с предупреждением.
	•	По-прежнему без хранения auth/config в vault (из-за sync).

12) Acceptance Criteria (готовность MVP)

MVP готов, если:
	1.	На macOS/Linux плагин устанавливается, sidebar открывается.
	2.	При отсутствии codex login плагин показывает “Needs login” и инструкцию.
	3.	При наличии логина плагин успешно отправляет запрос и получает ответ.
	4.	Активная заметка подхватывается, лимит 50k применяется (первые 50k).
	5.	История чата сохраняется между перезапусками Obsidian.
	6.	AGENTS.md создаётся в корне vault при установке плагина и не перезаписывается без команды.
	7.	Нет .codex/ в vault и нет изменений ~/.codex/config.toml.
